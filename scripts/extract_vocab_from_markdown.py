import re
import os
from collections import Counter
from pathlib import Path

STOPWORDS = set([
    # English stopwords (minimal)
    'the', 'and', 'of', 'to', 'a', 'in', 'for', 'is', 'on', 'that', 'with', 'as', 'by', 'an', 'be', 'are', 'from', 'at', 'or', 'it', 'this', 'which', 'can', 'was', 'will', 'not', 'has', 'have', 'but', 'if', 'they', 'their', 'you', 'all', 'one', 'we', 'more', 'so', 'do', 'no', 'any', 'each', 'than', 'other', 'such', 'may', 'when', 'who', 'what', 'how', 'where', 'your', 'our', 'these', 'also', 'its', 'use', 'used', 'using', 'should', 'into', 'between', 'been', 'being', 'about', 'out', 'up', 'down', 'over', 'under', 'new', 'some', 'most', 'many', 'like', 'just', 'get', 'set', 'make', 'now', 'then', 'after', 'before', 'because', 'while', 'during', 'through', 'even', 'both', 'first', 'last', 'same', 'different', 'very', 'much', 'few', 'less', 'lot', 'lots', 'got', 'still', 'see', 'go', 'back', 'off', 'here', 'there', 'where', 'why', 'who', 'whom', 'whose', 'which', 'what', 'when', 'how', 'would', 'could', 'should', 'might', 'must', 'shall', 'may', 'can', 'will', 'do', 'does', 'did', 'done', 'has', 'have', 'had', 'having', 'am', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'get', 'gets', 'got', 'getting', 'make', 'makes', 'made', 'making', 'go', 'goes', 'went', 'gone', 'going', 'see', 'sees', 'saw', 'seen', 'seeing', 'know', 'knows', 'knew', 'known', 'knowing', 'think', 'thinks', 'thought', 'thinking', 'say', 'says', 'said', 'saying', 'tell', 'tells', 'told', 'telling', 'ask', 'asks', 'asked', 'asking', 'work', 'works', 'worked', 'working', 'want', 'wants', 'wanted', 'wanting', 'need', 'needs', 'needed', 'needing', 'try', 'tries', 'tried', 'trying', 'use', 'uses', 'used', 'using', 'help', 'helps', 'helped', 'helping', 'find', 'finds', 'found', 'finding', 'show', 'shows', 'showed', 'showing', 'let', 'lets', 'let', 'letting', 'put', 'puts', 'putting', 'take', 'takes', 'took', 'taken', 'taking', 'give', 'gives', 'gave', 'given', 'giving', 'keep', 'keeps', 'kept', 'keeping', 'leave', 'leaves', 'left', 'leaving', 'call', 'calls', 'called', 'calling', 'feel', 'feels', 'felt', 'feeling', 'seem', 'seems', 'seemed', 'seeming', 'look', 'looks', 'looked', 'looking', 'sound', 'sounds', 'sounded', 'sounding', 'appear', 'appears', 'appeared', 'appearing', 'become', 'becomes', 'became', 'becoming', 'happen', 'happens', 'happened', 'happening', 'start', 'starts', 'started', 'starting', 'end', 'ends', 'ended', 'ending', 'run', 'runs', 'ran', 'running', 'move', 'moves', 'moved', 'moving', 'change', 'changes', 'changed', 'changing', 'turn', 'turns', 'turned', 'turning', 'open', 'opens', 'opened', 'opening', 'close', 'closes', 'closed', 'closing', 'begin', 'begins', 'began', 'begun', 'beginning', 'stop', 'stops', 'stopped', 'stopping', 'play', 'plays', 'played', 'playing', 'pay', 'pays', 'paid', 'paying', 'buy', 'buys', 'bought', 'buying', 'sell', 'sells', 'sold', 'selling', 'win', 'wins', 'won', 'winning', 'lose', 'loses', 'lost', 'losing', 'read', 'reads', 'read', 'reading', 'write', 'writes', 'wrote', 'written', 'writing', 'draw', 'draws', 'drew', 'drawn', 'drawing', 'build', 'builds', 'built', 'building', 'create', 'creates', 'created', 'creating', 'make', 'makes', 'made', 'making', 'produce', 'produces', 'produced', 'producing', 'develop', 'develops', 'developed', 'developing', 'design', 'designs', 'designed', 'designing', 'plan', 'plans', 'planned', 'planning', 'organize', 'organizes', 'organized', 'organizing', 'manage', 'manages', 'managed', 'managing', 'lead', 'leads', 'led', 'leading', 'direct', 'directs', 'directed', 'directing', 'control', 'controls', 'controlled', 'controlling', 'handle', 'handles', 'handled', 'handling', 'deal', 'deals', 'dealt', 'dealing', 'care', 'cares', 'cared', 'caring', 'serve', 'serves', 'served', 'serving', 'support', 'supports', 'supported', 'supporting', 'provide', 'provides', 'provided', 'providing', 'offer', 'offers', 'offered', 'offering', 'suggest', 'suggests', 'suggested', 'suggesting', 'recommend', 'recommends', 'recommended', 'recommending', 'advise', 'advises', 'advised', 'advising', 'allow', 'allows', 'allowed', 'allowing', 'permit', 'permits', 'permitted', 'permitting', 'forbid', 'forbids', 'forbade', 'forbidden', 'forbidding', 'prevent', 'prevents', 'prevented', 'preventing', 'stop', 'stops', 'stopped', 'stopping', 'block', 'blocks', 'blocked', 'blocking', 'limit', 'limits', 'limited', 'limiting', 'restrict', 'restricts', 'restricted', 'restricting', 'free', 'frees', 'freed', 'freeing', 'release', 'releases', 'released', 'releasing', 'save', 'saves', 'saved', 'saving', 'spend', 'spends', 'spent', 'spending', 'waste', 'wastes', 'wasted', 'wasting', 'lose', 'loses', 'lost', 'losing', 'miss', 'misses', 'missed', 'missing', 'fail', 'fails', 'failed', 'failing', 'succeed', 'succeeds', 'succeeded', 'succeeding', 'achieve', 'achieves', 'achieved', 'achieving', 'reach', 'reaches', 'reached', 'reaching', 'attain', 'attains', 'attained', 'attaining', 'gain', 'gains', 'gained', 'gaining', 'earn', 'earns', 'earned', 'earning', 'get', 'gets', 'got', 'getting', 'obtain', 'obtains', 'obtained', 'obtaining', 'acquire', 'acquires', 'acquired', 'acquiring', 'receive', 'receives', 'received', 'receiving', 'accept', 'accepts', 'accepted', 'accepting', 'refuse', 'refuses', 'refused', 'refusing', 'reject', 'rejects', 'rejected', 'rejecting', 'choose', 'chooses', 'chose', 'chosen', 'choosing', 'select', 'selects', 'selected', 'selecting', 'pick', 'picks', 'picked', 'picking', 'prefer', 'prefers', 'preferred', 'preferring', 'like', 'likes', 'liked', 'liking', 'love', 'loves', 'loved', 'loving', 'hate', 'hates', 'hated', 'hating', 'enjoy', 'enjoys', 'enjoyed', 'enjoying', 'prefer', 'prefers', 'preferred', 'preferring', 'wish', 'wishes', 'wished', 'wishing', 'hope', 'hopes', 'hoped', 'hoping', 'expect', 'expects', 'expected', 'expecting', 'wait', 'waits', 'waited', 'waiting', 'see', 'sees', 'saw', 'seen', 'seeing', 'look', 'looks', 'looked', 'looking', 'watch', 'watches', 'watched', 'watching', 'observe', 'observes', 'observed', 'observing', 'notice', 'notices', 'noticed', 'noticing', 'hear', 'hears', 'heard', 'hearing', 'listen', 'listens', 'listened', 'listening', 'sound', 'sounds', 'sounded', 'sounding', 'smell', 'smells', 'smelled', 'smelling', 'taste', 'tastes', 'tasted', 'tasting', 'feel', 'feels', 'felt', 'feeling', 'touch', 'touches', 'touched', 'touching', 'hold', 'holds', 'held', 'holding', 'keep', 'keeps', 'kept', 'keeping', 'carry', 'carries', 'carried', 'carrying', 'bring', 'brings', 'brought', 'bringing', 'take', 'takes', 'took', 'taken', 'taking', 'send', 'sends', 'sent', 'sending', 'fetch', 'fetches', 'fetched', 'fetching', 'deliver', 'delivers', 'delivered', 'delivering', 'draw', 'draws', 'drew', 'drawn', 'drawing', 'paint', 'paints', 'painted', 'painting', 'write', 'writes', 'wrote', 'written', 'writing', 'type', 'types', 'typed', 'typing', 'print', 'prints', 'printed', 'printing', 'copy', 'copies', 'copied', 'copying', 'paste', 'pastes', 'pasted', 'pasting', 'cut', 'cuts', 'cutting', 'delete', 'deletes', 'deleted', 'deleting', 'remove', 'removes', 'removed', 'removing', 'clean', 'cleans', 'cleaned', 'cleaning', 'wash', 'washes', 'washed', 'washing', 'cook', 'cooks', 'cooked', 'cooking', 'bake', 'bakes', 'baked', 'baking', 'boil', 'boils', 'boiled', 'boiling', 'fry', 'fries', 'fried', 'frying', 'grill', 'grills', 'grilled', 'grilling', 'roast', 'roasts', 'roasted', 'roasting', 'steam', 'steams', 'steamed', 'steaming', 'burn', 'burns', 'burned', 'burning', 'freeze', 'freezes', 'froze', 'frozen', 'freezing', 'melt', 'melts', 'melted', 'melting', 'heat', 'heats', 'heated', 'heating', 'cool', 'cools', 'cooled', 'cooling', 'warm', 'warms', 'warmed', 'warming', 'chill', 'chills', 'chilled', 'chilling', 'mix', 'mixes', 'mixed', 'mixing', 'blend', 'blends', 'blended', 'blending', 'combine', 'combines', 'combined', 'combining', 'separate', 'separates', 'separated', 'separating', 'divide', 'divides', 'divided', 'dividing', 'split', 'splits', 'split', 'splitting', 'add', 'adds', 'added', 'adding', 'subtract', 'subtracts', 'subtracted', 'subtracting', 'multiply', 'multiplies', 'multiplied', 'multiplying', 'divide', 'divides', 'divided', 'dividing', 'increase', 'increases', 'increased', 'increasing', 'decrease', 'decreases', 'decreased', 'decreasing', 'raise', 'raises', 'raised', 'raising', 'lower', 'lowers', 'lowered', 'lowering', 'grow', 'grows', 'grew', 'grown', 'growing', 'shrink', 'shrinks', 'shrank', 'shrunk', 'shrinking', 'expand', 'expands', 'expanded', 'expanding', 'contract', 'contracts', 'contracted', 'contracting', 'extend', 'extends', 'extended', 'extending', 'shorten', 'shortens', 'shortened', 'shortening', 'lengthen', 'lengthens', 'lengthened', 'lengthening', 'widen', 'widens', 'widened', 'widening', 'narrow', 'narrows', 'narrowed', 'narrowing', 'broaden', 'broadens', 'broadened', 'broadening', 'deepen', 'deepens', 'deepened', 'deepening', 'shallow', 'shallows', 'shallowed', 'shallowing', 'thicken', 'thickens', 'thickened', 'thickening', 'thin', 'thins', 'thinned', 'thinning', 'lighten', 'lightens', 'lightened', 'lightening', 'darken', 'darkens', 'darkened', 'darkening', 'brighten', 'brightens', 'brightened', 'brightening', 'dim', 'dims', 'dimmed', 'dimming', 'clear', 'clears', 'cleared', 'clearing', 'cloud', 'clouds', 'clouded', 'clouding', 'rain', 'rains', 'rained', 'raining', 'snow', 'snows', 'snowed', 'snowing', 'wind', 'winds', 'winded', 'winding', 'storm', 'storms', 'stormed', 'storming', 'sun', 'suns', 'sunned', 'sunning', 'moon', 'moons', 'mooned', 'mooning', 'star', 'stars', 'starred', 'starring', 'planet', 'planets', 'planeted', 'planeting', 'earth', 'earths', 'earthed', 'earthing', 'ground', 'grounds', 'grounded', 'grounding', 'rock', 'rocks', 'rocked', 'rocking', 'stone', 'stones', 'stoned', 'stoning', 'sand', 'sands', 'sanded', 'sanding', 'soil', 'soils', 'soiled', 'soiling', 'clay', 'clays', 'clayed', 'claying', 'mud', 'muds', 'mudded', 'mudding', 'dust', 'dusts', 'dusted', 'dusting', 'dirt', 'dirts', 'dirtied', 'dirtying', 'clean', 'cleans', 'cleaned', 'cleaning', 'wash', 'washes', 'washed', 'washing', 'dry', 'dries', 'dried', 'drying', 'wet', 'wets', 'wetted', 'wetting', 'moist', 'moists', 'moisted', 'moisting', 'humid', 'humids', 'humidified', 'humidifying', 'dry', 'dries', 'dried', 'drying', 'hot', 'hots', 'hotted', 'hotting', 'cold', 'colds', 'colded', 'colding', 'warm', 'warms', 'warmed', 'warming', 'cool', 'cools', 'cooled', 'cooling', 'freeze', 'freezes', 'froze', 'frozen', 'freezing', 'melt', 'melts', 'melted', 'melting', 'boil', 'boils', 'boiled', 'boiling', 'burn', 'burns', 'burned', 'burning', 'cook', 'cooks', 'cooked', 'cooking', 'bake', 'bakes', 'baked', 'baking', 'fry', 'fries', 'fried', 'frying', 'grill', 'grills', 'grilled', 'grilling', 'roast', 'roasts', 'roasted', 'roasting', 'steam', 'steams', 'steamed', 'steaming', 'smoke', 'smokes', 'smoked', 'smoking', 'fire', 'fires', 'fired', 'firing', 'burn', 'burns', 'burned', 'burning', 'light', 'lights', 'lighted', 'lighting', 'dark', 'darks', 'darked', 'darking', 'shine', 'shines', 'shined', 'shining', 'glow', 'glows', 'glowed', 'glowing', 'spark', 'sparks', 'sparked', 'sparking', 'flash', 'flashes', 'flashed', 'flashing', 'blink', 'blinks', 'blinked', 'blinking', 'twinkle', 'twinkles', 'twinkled', 'twinkling', 'flicker', 'flickers', 'flickered', 'flickering', 'glimmer', 'glimmers', 'glimmered', 'glimmering', 'gleam', 'gleams', 'gleamed', 'gleaming', 'shine', 'shines', 'shined', 'shining', 'glow', 'glows', 'glowed', 'glowing', 'spark', 'sparks', 'sparked', 'sparking', 'flash', 'flashes', 'flashed', 'flashing', 'blink', 'blinks', 'blinked', 'blinking', 'twinkle', 'twinkles', 'twinkled', 'twinkling', 'flicker', 'flickers', 'flickered', 'flickering', 'glimmer', 'glimmers', 'glimmered', 'glimmering', 'gleam', 'gleams', 'gleamed', 'gleaming', 'shine', 'shines', 'shined', 'shining', 'glow', 'glows', 'glowed', 'glowing', 'spark', 'sparks', 'sparked', 'sparking', 'flash', 'flashes', 'flashed', 'flashing', 'blink', 'blinks', 'blinked', 'blinking', 'twinkle', 'twinkles', 'twinkled', 'twinkling', 'flicker', 'flickers', 'flickered', 'flickering', 'glimmer', 'glimmers', 'glimmered', 'glimmering', 'gleam', 'gleams', 'gleamed', 'gleaming'])


def extract_vocab_from_markdown(directory, min_freq=1, top_k=3000):
    """
    Extract unique vocabulary from all markdown files in a directory.
    Args:
        directory: Path to directory containing .md files
        min_freq: Minimum frequency for a word to be included
        top_k: Maximum number of words to keep (by frequency)
    Returns:
        List of words (sorted by frequency)
    """
    counter = Counter()
    for md_file in Path(directory).rglob("*.md"):
        with open(md_file, encoding="utf-8") as f:
            text = f.read().lower()
            # Remove markdown formatting and code blocks
            text = re.sub(r'```[\s\S]*?```', '', text)
            text = re.sub(r'[#*\-\[\]()`~_>]', ' ', text)
            # Tokenize words
            words = re.findall(r"\b[a-zA-Z0-9\-\_\+\.]+\b", text)
            # Remove stopwords and single char
            words = [w for w in words if w not in STOPWORDS and len(w) > 1]
            counter.update(words)
    # Keep only top_k most common
    vocab = [w for w, c in counter.most_common() if c >= min_freq][:top_k]
    return vocab


def save_vocab(vocab, output_file):
    with open(output_file, "w", encoding="utf-8") as f:
        for w in vocab:
            f.write(w + "\n")


if __name__ == "__main__":
    import argparse
    parser = argparse.ArgumentParser(description="Extract vocabulary from markdown files.")
    parser.add_argument("directory", help="Directory containing .md files")
    parser.add_argument("--output", default="vocab.txt", help="Output vocab file")
    parser.add_argument("--min-freq", type=int, default=1, help="Minimum frequency for a word to be included")
    parser.add_argument("--top-k", type=int, default=3000, help="Maximum number of words to keep")
    args = parser.parse_args()

    vocab = extract_vocab_from_markdown(args.directory, min_freq=args.min_freq, top_k=args.top_k)
    print(f"Extracted {len(vocab)} words.")
    save_vocab(vocab, args.output)
    print(f"Vocabulary saved to {args.output}")
